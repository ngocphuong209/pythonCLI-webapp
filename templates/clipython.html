<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Web IDE - Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/nord.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/R0NfXPH8/Thi-t-k-ch-a-c-t-n-12.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Fira Code', monospace;
        }

        .CodeMirror {
            height: calc(100vh - 12rem);
            border-radius: 0.5rem;
            font-size: 14px;
        }

        @media (max-width: 640px) {
            .CodeMirror {
                height: calc(100vh - 16rem);
                font-size: 12px;
            }
        }

        .cm-s-nord.CodeMirror {
            background-color: #2e3440;
            color: #d8dee9;
        }

        .cm-s-nord .CodeMirror-gutters {
            background-color: #3b4252;
            border-right: 1px solid #4c566a;
        }

        .cm-s-nord .CodeMirror-linenumber {
            color: #4c566a;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #3b4252;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4c566a;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #5e81ac;
        }

        .glass-effect {
            background: rgba(46, 52, 64, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 86, 106, 0.5);
        }

        .sidebar-transition {
            transition: all 0.3s ease-in-out;
        }

        @media (max-width: 640px) {
            .action-buttons {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: #2e3440;
                padding: 0.5rem;
                display: flex;
                justify-content: space-around;
                z-index: 50;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-900 to-blue-900 min-h-screen text-white font-sans">
    <div class="flex flex-col h-screen overflow-hidden">
        <!-- Top bar -->
        <header class="bg-gray-800 p-4 flex justify-between items-center">
            <div class="flex items-center">
                <button id="sidebarToggle" class="text-white focus:outline-none mr-4">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="text-xl font-bold hidden sm:block">Python Web IDE</h1>
            </div>
            <div class="flex space-x-2 action-buttons sm:relative">
                <button id="runBtn"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center text-sm sm:text-base">
                    <i class="fas fa-play mr-2"></i> <span class="hidden sm:inline">Run</span>
                </button>
                <button id="clearBtn"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center text-sm sm:text-base">
                    <i class="fas fa-trash-alt mr-2"></i> <span class="hidden sm:inline">Clear</span>
                </button>
                <button id="saveBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center text-sm sm:text-base">
                    <i class="fas fa-save mr-2"></i> <span class="hidden sm:inline">Save</span>
                </button>
                <button id="shareBtn"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center text-sm sm:text-base">
                    <i class="fas fa-share-alt mr-2"></i> <span class="hidden sm:inline">Share</span>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar"
                class="w-64 bg-gray-800 text-white p-4 sidebar-transition transform -translate-x-full absolute inset-y-0 left-0 z-50 lg:relative lg:translate-x-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Python IDE</h2>
                    <button id="closeSidebarBtn" class="lg:hidden text-white focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <nav class="space-y-4">
                    <button id="settingsBtn"
                        class="w-full flex items-center justify-between p-2 rounded hover:bg-gray-700 transition-colors">
                        <span><i class="fas fa-cog mr-2"></i> Cài đặt</span>
                        <i class="fas fa-chevron-right text-sm"></i>
                    </button>
                    <button id="themeToggleBtn"
                        class="w-full flex items-center justify-between p-2 rounded hover:bg-gray-700 transition-colors">
                        <span><i class="fas fa-adjust mr-2"></i> Giao diện</span>
                        <span id="themeStatus" class="text-xs bg-blue-600 px-2 py-1 rounded">Sáng</span>
                    </button>
                    <button id="fullscreenBtn"
                        class="w-full flex items-center justify-between p-2 rounded hover:bg-gray-700 transition-colors">
                        <span><i class="fas fa-expand-arrows-alt mr-2"></i> Toàn màn hình</span>
                    </button>
                </nav>
                <div id="advancedOptions" class="mt-6 space-y-4 hidden">
                    <h3 class="text-lg font-semibold">Tùy chọn nâng cao</h3>
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="inputRequired"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="inputRequired" class="text-sm">Yêu cầu nhập dữ liệu</label>
                    </div>
                    <div id="inputValueContainer" class="hidden">
                        <textarea id="inputValue"
                            class="w-full p-2 bg-gray-700 border border-gray-600 rounded resize-y custom-scrollbar text-white text-sm"
                            rows="3" placeholder="Nhập các giá trị, mỗi giá trị trên một dòng..."></textarea>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-2">Thư viện có sẵn:</h3>
                    <ul id="libraryList" class="text-sm space-y-1 pl-4 list-disc">
                        <li>numpy</li>
                        <li>pandas</li>
                        <li>matplotlib</li>
                        <li>scikit-learn</li>
                        <li>tensorflow</li>
                    </ul>
                </div>
            </aside>

            <!-- Main content -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <!-- Editor area -->
                <div class="flex-1 overflow-hidden">
                    <div id="editor" class="w-full h-full"></div>
                </div>

                <!-- Output area -->
                <footer id="output" class="bg-gray-800 p-4 hidden">
                    <h2 class="text-xl font-semibold mb-2 text-blue-400">Kết quả:</h2>
                    <pre id="outputContent"
                        class="bg-gray-900 p-4 rounded-lg shadow-inner text-sm overflow-x-auto custom-scrollbar text-green-400 max-h-40"></pre>
                </footer>
            </main>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
    <script>
        let editor;
        let currentTheme = 'nord';

        function initializeEditor() {
            editor = CodeMirror(document.getElementById("editor"), {
                mode: "python",
                theme: currentTheme,
                lineNumbers: true,
                autofocus: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                matchBrackets: true,
                autoCloseBrackets: true,
                styleActiveLine: true,
                extraKeys: {
                    "Ctrl-Space": "autocomplete",
                    "Ctrl-/": "toggleComment",
                    "Cmd-/": "toggleComment"
                }
            });
        }

        initializeEditor();

        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const closeSidebarBtn = document.getElementById("closeSidebarBtn");
        const inputRequired = document.getElementById("inputRequired");
        const inputValueContainer = document.getElementById("inputValueContainer");
        const runBtn = document.getElementById("runBtn");
        const clearBtn = document.getElementById("clearBtn");
        const saveBtn = document.getElementById("saveBtn");
        const shareBtn = document.getElementById("shareBtn");
        const fullscreenBtn = document.getElementById("fullscreenBtn");
        const settingsBtn = document.getElementById("settingsBtn");
        const themeToggleBtn = document.getElementById("themeToggleBtn");
        const themeStatus = document.getElementById("themeStatus");
        const advancedOptions = document.getElementById("advancedOptions");
        const output = document.getElementById("output");
        const outputContent = document.getElementById("outputContent");

        sidebarToggle.addEventListener("click", () => {
            sidebar.classList.toggle("-translate-x-full");
        });

        closeSidebarBtn.addEventListener("click", () => {
            sidebar.classList.add("-translate-x-full");
        });

        inputRequired.addEventListener("change", function () {
            inputValueContainer.style.display = this.checked ? "block" : "none";
        });

        settingsBtn.addEventListener("click", function () {
            advancedOptions.classList.toggle("hidden");
            settingsBtn.querySelector("i:last-child").classList.toggle("fa-chevron-down");
            settingsBtn.querySelector("i:last-child").classList.toggle("fa-chevron-right");
        });

        themeToggleBtn.addEventListener("click", function () {
            currentTheme = currentTheme === 'nord' ? 'default' : 'nord';
            editor.setOption("theme", currentTheme);
            document.body.classList.toggle("dark");
            themeStatus.textContent = currentTheme === 'nord' ? 'Tối' : 'Sáng';
        });

        runBtn.addEventListener("click", async function () {
            const code = editor.getValue();
            const inputValue = document.getElementById("inputValue").value;

            try {
                runBtn.disabled = true;
                runBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> <span class="hidden sm:inline">Đang chạy...</span>';
                const response = await fetch("/run-python", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        code: code,
                        input_values: inputRequired.checked ? inputValue.split("\n") : []
                    }),
                });

                const result = await response.json();
                output.style.display = "block";
                outputContent.textContent = result.output;

                if (result.error) {
                    outputContent.classList.add("text-red-500");
                    outputContent.classList.remove("text-green-400");
                } else {
                    outputContent.classList.remove("text-red-500");
                    outputContent.classList.add("text-green-400");
                }
            } catch (error) {
                console.error("Error:", error);
                output.style.display = "block";
                outputContent.textContent = "Đã xảy ra lỗi khi chạy mã Python.";
                outputContent.classList.add("text-red-500");
                outputContent.classList.remove("text-green-400");
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="fas fa-play mr-2"></i> <span class="hidden sm:inline">Chạy</span>';
            }
        });

        clearBtn.addEventListener("click", function () {
            editor.setValue("");
            document.getElementById("inputValue").value = "";
            output.style.display = "none";
        });

        saveBtn.addEventListener("click", function () {
            const code = editor.getValue();
            const blob = new Blob([code], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "python_code.py";
            link.click();
        });

        shareBtn.addEventListener("click", async function () {
            const code = editor.getValue();

            try {
                shareBtn.disabled = true;
                shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> <span class="hidden sm:inline">Đang chia sẻ...</span>';
                const response = await fetch("/share-code", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ code: code }),
                });
                const result = await response.json();
                if (result.share_url) {
                    const shareUrl = `https://python-cli-webapp.vercel.app${result.share_url}`;
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        alert(`Mã của bạn đã được chia sẻ. URL đã được sao chép vào clipboard: ${shareUrl}`);
                    }, (err) => {
                        alert(`Mã của bạn đã được chia sẻ. URL: ${shareUrl}`);
                    });
                } else {
                    alert("Có lỗi xảy ra khi chia sẻ mã.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Có lỗi xảy ra khi chia sẻ mã.");
            } finally {
                shareBtn.disabled = false;
                shareBtn.innerHTML = '<i class="fas fa-share-alt mr-2"></i> <span class="hidden sm:inline">Chia sẻ</span>';
            }
        });

        fullscreenBtn.addEventListener("click", function () {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                fullscreenBtn.innerHTML = '<i class="fas fa-compress-arrows-alt mr-2"></i>Thu nhỏ';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand-arrows-alt mr-2"></i>Toàn màn hình';
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey && event.key === 'Enter') {
                runBtn.click();
            }
        });

        // Add some sample code to the editor
        editor.setValue(`# Tanbaycu 
# Hãy thử chạy đoạn mã mẫu này:

def fibonacci(n):
    if n <= 1:
        return n
    else:
        return fibonacci(n-1) + fibonacci(n-2)

print("Dãy số Fibonacci:")
for i in range(10):
    print(fibonacci(i), end=" ")
`);

        window.addEventListener('resize', function () {
            editor.refresh();
        });

        function addLibrary(libraryName) {
            const libraryList = document.getElementById('libraryList');
            const li = document.createElement('li');
            li.textContent = libraryName;
            libraryList.appendChild(li);
        }
    </script>
</body>

</html>