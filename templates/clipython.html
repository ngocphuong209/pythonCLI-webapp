<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Python Web IDE - Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/nord.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="https://i.postimg.cc/R0NfXPH8/Thi-t-k-ch-a-c-t-n-12.png" />
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap");

        body {
            font-family: "Fira Code", monospace;
        }

        .CodeMirror {
            height: 100%;
            font-size: 14px;
        }

        .cm-s-nord.CodeMirror {
            background-color: #2e3440;
            color: #d8dee9;
        }

        .cm-s-nord .CodeMirror-gutters {
            background-color: #3b4252;
            border-right: 1px solid #4c566a;
        }

        .cm-s-nord .CodeMirror-linenumber {
            color: #4c566a;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #3b4252;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4c566a;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #5e81ac;
        }

        .glass-effect {
            background: rgba(46, 52, 64, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 86, 106, 0.5);
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 64px);
        }

        #editor {
            flex-grow: 1;
            overflow: auto;
        }

        #resultArea {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #2e3440;
            transition: all 0.3s ease-in-out;
            z-index: 1000;
            max-height: 50vh;
        }

        #resultContent,
        #consoleContent,
        #aiContent {
            max-height: calc(50vh - 40px);
            overflow-y: auto;
        }

        #sidebar {
            background: linear-gradient(135deg, #2a3f5f 0%, #1e2a3a 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
        }

        .sidebar-item {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #88c0d0;
            transform: translateX(5px);
        }

        .sidebar-item::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg,
                    transparent,
                    rgba(255, 255, 255, 0.1),
                    transparent);
            transform: translateX(-100%);
            transition: 0.5s;
        }

        .sidebar-item:hover::after {
            transform: translateX(100%);
        }

        .sidebar-icon {
            transition: all 0.3s ease;
        }

        .sidebar-item:hover .sidebar-icon {
            transform: scale(1.2) rotate(360deg);
        }

        .advanced-options {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .advanced-options.show {
            max-height: 500px;
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4c566a;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: #d8dee9;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #88c0d0;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        .library-item {
            transition: all 0.3s ease;
        }

        .library-item:hover {
            transform: translateX(5px);
            color: #88c0d0;
        }

        @media (max-width: 640px) {
            .CodeMirror {
                font-size: 12px;
            }

            .editor-container {
                height: calc(100vh - 128px);
            }

            #resultArea {
                bottom: 60px;
            }

            #sidebar {
                width: 100%;
                max-width: 300px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background-color: #2e3440;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #3b4252;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            font-weight: bold;
            color: #88c0d0;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: #d8dee9;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #bf616a;
        }

        .modal-body {
            padding: 20px;
        }

        .share-section,
        .qr-section,
        .share-options {
            margin-bottom: 20px;
        }

        .share-section h3,
        .qr-section h3,
        .share-options h3 {
            font-size: 1.2rem;
            color: #eceff4;
            margin-bottom: 10px;
        }

        .copy-link {
            display: flex;
            background-color: #3b4252;
            border-radius: 8px;
            overflow: hidden;
        }

        .copy-link input {
            flex-grow: 1;
            padding: 10px;
            border: none;
            background-color: transparent;
            color: #eceff4;
            font-size: 0.9rem;
        }

        .copy-btn {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: #5e81ac;
            border: none;
            color: #eceff4;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .copy-btn:hover {
            background-color: #81a1c1;
        }

        .copy-btn i {
            margin-right: 5px;
        }

        .qrcode-container {
            display: flex;
            justify-content: center;
            background-color: #eceff4;
            padding: 20px;
            border-radius: 10px;
        }

        .social-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .social-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            color: #eceff4;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .social-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .facebook {
            background-color: #3b5998;
        }

        .twitter {
            background-color: #1da1f2;
        }

        .linkedin {
            background-color: #0077b5;
        }

        .email {
            background-color: #d44638;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #3b4252;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: #5e81ac;
            color: #eceff4;
        }

        .btn-primary:hover {
            background-color: #81a1c1;
        }

        .btn-secondary {
            background-color: #4c566a;
            color: #eceff4;
        }

        .btn-secondary:hover {
            background-color: #6b7a8f;
        }

        .btn i {
            margin-right: 5px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content>* {
            animation: slideIn 0.5s ease forwards;
        }

        .modal-content>*:nth-child(1) {
            animation-delay: 0.1s;
        }

        .modal-content>*:nth-child(2) {
            animation-delay: 0.2s;
        }

        .modal-content>*:nth-child(3) {
            animation-delay: 0.3s;
        }

        .tab-buttons {
            display: flex;
            background-color: #3b4252;
            border-bottom: 1px solid #4c566a;
        }

        .tab-button {
            padding: 10px 20px;
            background-color: transparent;
            border: none;
            color: #d8dee9;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .tab-button.active {
            background-color: #4c566a;
            color: #88c0d0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #consoleInput,
        #aiInput {
            width: 100%;
            padding: 10px;
            background-color: #3b4252;
            border: none;
            border-top: 1px solid #4c566a;
            color: #d8dee9;
            font-family: "Fira Code", monospace;
        }

        #consoleInput:focus,
        #aiInput:focus {
            outline: none;
            background-color: #434c5e;
        }

        #consoleOutput,
        #aiOutput {
            padding: 10px;
            font-family: "Fira Code", monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .console-input,
        .ai-input {
            color: #88c0d0;
        }

        .console-output,
        .ai-output {
            color: #a3be8c;
        }

        .console-error,
        .ai-error.console-error,
        .ai-error {
            color: #bf616a;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #4c566a;
        }

        .chat-input {
            flex-grow: 1;
            padding: 10px;
            background-color: #3b4252;
            border: none;
            color: #d8dee9;
            font-family: "Fira Code", monospace;
        }

        .chat-input:focus {
            outline: none;
            background-color: #434c5e;
        }

        .chat-send-btn {
            padding: 10px 20px;
            background-color: #5e81ac;
            border: none;
            color: #eceff4;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .chat-send-btn:hover {
            background-color: #81a1c1;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .user-message {
            background-color: #4c566a;
            align-self: flex-end;
        }

        .ai-message {
            background-color: #3b4252;
            align-self: flex-start;
        }

        .message-content {
            margin-top: 5px;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content code {
            background-color: #2e3440;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .message-content pre {
            background-color: #2e3440;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .chat-fullscreen-btn {
            padding: 10px 20px;
            background-color: #5e81ac;
            border: none;
            color: #eceff4;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-left: 10px;
        }

        .chat-fullscreen-btn:hover {
            background-color: #81a1c1;
        }

        .ai-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background-color: #2e3440;
            display: flex;
            flex-direction: column;
        }

        .ai-fullscreen .chat-container {
            height: 100%;
        }

        .ai-fullscreen .chat-messages {
            flex-grow: 1;
        }

        .ai-fullscreen .chat-input-container {
            padding: 20px;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-900 to-blue-900 text-white font-sans">
    <div class="flex flex-col min-h-screen">
        <!-- Top bar -->
        <header class="bg-gray-800 p-4 flex justify-between items-center">
            <div class="flex items-center">
                <button id="sidebarToggle" class="text-white focus:outline-none mr-4">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="text-xl font-bold hidden sm:block">Python Web IDE</h1>
            </div>
            <div class="flex space-x-2 sm:relative">
                <button id="runBtn"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center justify-center"
                    title="Chạy code (Ctrl + Enter)">
                    <i class="fas fa-play mr-2"></i>
                    <span class="hidden sm:inline">Chạy</span>
                </button>
                <button id="clearBtn"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center justify-center"
                    title="Xóa code và kết quả">
                    <i class="fas fa-trash-alt mr-2"></i>
                    <span class="hidden sm:inline">Xóa</span>
                </button>
                <button id="saveBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center justify-center"
                    title="Lưu code vào máy">
                    <i class="fas fa-save mr-2"></i>
                    <span class="hidden sm:inline">Lưu</span>
                </button>
                <button id="shareBtn"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center justify-center"
                    title="Chia sẻ code">
                    <i class="fas fa-share-alt mr-2"></i>
                    <span class="hidden sm:inline">Chia sẻ</span>
                </button>
            </div>
        </header>

        <!-- Notification area -->
        <div id="notificationArea" class="fixed top-4 right-4 space-y-2 z-50"></div>

        <!-- Share Modal -->
        <div id="shareModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Chia sẻ mã của bạn</h2>
                    <button id="closeModalBtn" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="share-section">
                        <h3>Liên kết chia sẻ</h3>
                        <div class="copy-link" id="copyLinkBtn">
                            <input type="text" id="shareUrl" readonly />
                            <button class="copy-btn">
                                <i class="fas fa-copy"></i>
                                <span>Sao chép</span>
                            </button>
                        </div>
                    </div>
                    <div class="qr-section">
                        <h3>Mã QR</h3>
                        <div class="qrcode-container">
                            <div id="qrcode"></div>
                        </div>
                    </div>
                    <div class="share-options">
                        <h3>Chia sẻ qua</h3>
                        <div class="social-buttons">
                            <button class="social-btn facebook">
                                <i class="fab fa-facebook-f"></i>
                            </button>
                            <button class="social-btn twitter">
                                <i class="fab fa-twitter"></i>
                            </button>
                            <button class="social-btn linkedin">
                                <i class="fab fa-linkedin-in"></i>
                            </button>
                            <button class="social-btn email">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="openLinkBtn" class="btn btn-primary">
                        <i class="fas fa-external-link-alt"></i>
                        Mở liên kết
                    </button>
                    <button id="closeModalBtn2" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Đóng
                    </button>
                </div>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <!-- Improved Sidebar -->
            <aside id="sidebar"
                class="w-64 text-white p-4 transform -translate-x-full fixed inset-y-0 left-0 z-50 lg:relative lg:translate-x-0 overflow-y-auto transition-all duration-300 ease-in-out">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-blue-300"></h2>
                    <button id="closeSidebarBtn" class="lg:hidden text-white focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <nav class="space-y-4">
                    <button id="settingsBtn"
                        class="sidebar-item w-full flex items-center justify-between p-3 rounded transition-colors">
                        <span><i class="fas fa-cog mr-2 sidebar-icon"></i> Cài đặt</span>
                        <i class="fas fa-chevron-right text-sm"></i>
                    </button>
                    <div class="sidebar-item w-full flex items-center justify-between p-3 rounded transition-colors">
                        <span><i class="fas fa-adjust mr-2 sidebar-icon"></i> Giao diện</span>
                        <label class="theme-switch">
                            <input type="checkbox" id="themeToggle" />
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="fullscreenBtn"
                        class="sidebar-item w-full flex items-center justify-between p-3 rounded transition-colors">
                        <span><i class="fas fa-expand-arrows-alt mr-2 sidebar-icon"></i> Toàn
                            màn hình</span>
                    </button>
                </nav>
                <div id="advancedOptions" class="advanced-options mt-6 space-y-4">
                    <h3 class="text-lg font-semibold text-blue-300">
                        Tùy chọn nâng cao
                    </h3>
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="inputRequired"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" />
                        <label for="inputRequired" class="text-sm">Yêu cầu nhập dữ liệu</label>
                    </div>
                    <div id="inputValueContainer" class="hidden">
                        <textarea id="inputValue"
                            class="w-full p-2 bg-gray-700 border border-gray-600 rounded resize-y custom-scrollbar text-white text-sm"
                            rows="3" placeholder="Nhập các giá trị, mỗi giá trị trên một dòng..."></textarea>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-2 text-blue-300">
                        Thư viện có sẵn:
                    </h3>
                    <div id="libraryList" class="grid grid-cols-2 gap-2 text-sm">
                        <!-- Thư viện sẽ được thêm động bằng JavaScript -->
                    </div>
                </div>
            </aside>

            <!-- Main content -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <!-- Editor area -->
                <div class="editor-container">
                    <div id="editor"></div>
                </div>
            </main>
        </div>

        <!-- Result area -->
        <div id="resultArea" class="bg-gray-800 overflow-hidden transition-all duration-300 ease-in-out">
            <div class="flex justify-between items-center p-2 bg-gray-700">
                <div class="tab-buttons">
                    <button id="resultTab" class="tab-button active">Kết quả</button>
                    <button id="consoleTab" class="tab-button">Console</button>
                    <button id="aiTab" class="tab-button">AI</button>
                </div>
                <button id="toggleResult" class="text-white focus:outline-none">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div id="resultContent" class="tab-content active">
                <pre id="resultOutput"
                    class="p-4 bg-gray-900 text-sm overflow-y-auto custom-scrollbar text-green-400"></pre>
            </div>
            <div id="consoleContent" class="tab-content">
                <div id="consoleOutput" class="p-4 bg-gray-900 text-sm overflow-y-auto custom-scrollbar"></div>
                <input type="text" id="consoleInput" placeholder="Nhập lệnh Python..."
                    class="w-full p-2 bg-gray-800 text-white" />
            </div>
            <div id="aiContent" class="tab-content">
                <div class="chat-container">
                    <div id="aiOutput" class="chat-messages custom-scrollbar"></div>
                    <div class="chat-input-container">
                        <input type="text" id="aiInput" placeholder="Nhập câu hỏi cho AI..." class="chat-input" />
                        <button id="aiSendBtn" class="chat-send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button id="aiFullscreenBtn" class="chat-fullscreen-btn">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/comment/comment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
    <script>
        let editor;
        let currentTheme = "nord";
        let consoleHistory = [];
        let historyIndex = -1;
        let previousRuns = [];
        let chatHistory = [];
        let isAIFullscreen = false;

        // Danh sách thư viện có sẵn
        const libraries = [
            { name: "math", category: "Toán học", icon: "fa-calculator" },
            { name: "random", category: "Ngẫu nhiên", icon: "fa-dice" },
            { name: "datetime", category: "Ngày giờ", icon: "fa-calendar-alt" },
            { name: "json", category: "Xử lý dữ liệu", icon: "fa-code" },
            { name: "re", category: "Biểu thức chính quy", icon: "fa-search" },
            { name: "collections", category: "Cấu trúc dữ liệu", icon: "fa-layer-group" },
            { name: "itertools", category: "Lặp và tổ hợp", icon: "fa-infinity" },
            { name: "functools", category: "Lập trình hàm", icon: "fa-project-diagram" },
            { name: "heapq", category: "Heap", icon: "fa-sort-amount-up" },
            { name: "bisect", category: "Tìm kiếm nhị phân", icon: "fa-search-plus" },
            { name: "statistics", category: "Thống kê", icon: "fa-chart-bar" },
            { name: "array", category: "Mảng", icon: "fa-th-list" },
            { name: "decimal", category: "Số thập phân", icon: "fa-calculator" },
            { name: "fractions", category: "Phân số", icon: "fa-divide" },
            { name: "operator", category: "Toán tử", icon: "fa-plus-circle" }
        ];

        function initializeEditor() {
            editor = CodeMirror(document.getElementById("editor"), {
                mode: "python",
                theme: currentTheme,
                lineNumbers: true,
                autofocus: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                matchBrackets: true,
                autoCloseBrackets: true,
                styleActiveLine: true,
                extraKeys: {
                    "Ctrl-Space": "autocomplete",
                    "Ctrl-/": "toggleComment",
                    "Cmd-/": "toggleComment"
                }
            });

            // Thêm tính năng gợi ý code
            editor.on("inputRead", function (editor, change) {
                if (change.origin !== "+input") return;
                const cur = editor.getCursor();
                const token = editor.getTokenAt(cur);
                if (token.type === "variable" || token.string === ".") {
                    CodeMirror.showHint(editor, CodeMirror.hint.python, {
                        completeSingle: false
                    });
                }
            });
        }

        function renderLibraries() {
            const libraryList = document.getElementById("libraryList");
            libraryList.innerHTML = libraries
                .map(
                    (lib) => `
                    <div class="library-item p-2 bg-gray-700 rounded flex items-center space-x-2">
                        <i class="fas ${lib.icon}"></i>
                        <span>${lib.name}</span>
                    </div>
                `
                )
                .join("");
        }

        function showToast(message, type = "info") {
            const toast = document.createElement("div");
            toast.className = `p-3 rounded-lg shadow-lg ${type === "success"
                    ? "bg-green-600"
                    : type === "error"
                        ? "bg-red-600"
                        : "bg-blue-600"
                } text-white`;
            toast.textContent = message;
            const notificationArea = document.getElementById("notificationArea");
            notificationArea.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showShareModal(shareUrl) {
            const modal = document.getElementById("shareModal");
            const shareUrlElement = document.getElementById("shareUrl");
            const qrcodeContainer = document.getElementById("qrcode");

            // Hiển thị URL chia sẻ
            shareUrlElement.value = shareUrl;

            // Tạo mã QR code
            qrcodeContainer.innerHTML = "";
            new QRCode(qrcodeContainer, {
                text: shareUrl,
                width: 200,
                height: 200,
                colorDark: "#2e3440",
                colorLight: "#eceff4"
            });

            // Hiển thị modal
            modal.style.display = "flex";
            setTimeout(() => modal.classList.add("show"), 10);
        }

        function closeShareModal() {
            const modal = document.getElementById("shareModal");
            modal.classList.remove("show");
            setTimeout(() => (modal.style.display = "none"), 300);
        }

        function updateCodeSuggestions() {
            const currentCode = editor.getValue();
            if (currentCode && !previousRuns.includes(currentCode)) {
                previousRuns.unshift(currentCode);
                if (previousRuns.length > 5) {
                    previousRuns.pop();
                }
            }

            CodeMirror.registerHelper("hint", "python", function (cm) {
                const cursor = cm.getCursor();
                const token = cm.getTokenAt(cursor);
                const start = token.start;
                const end = cursor.ch;
                const line = cm.getLine(cursor.line);
                const currentWord = line.slice(start, end);

                const suggestions = [];
                previousRuns.forEach((run) => {
                    const lines = run.split("\n");
                    lines.forEach((line) => {
                        if (line.includes(currentWord) && !suggestions.includes(line)) {
                            suggestions.push(line);
                        }
                    });
                });

                return {
                    list: suggestions,
                    from: CodeMirror.Pos(cursor.line, start),
                    to: CodeMirror.Pos(cursor.line, end)
                };
            });
        }

        initializeEditor();
        renderLibraries();

        // Event Listeners
        document
            .getElementById("shareBtn")
            .addEventListener("click", async function () {
                const code = editor.getValue();

                try {
                    const response = await fetch("/share-code", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ code: code })
                    });
                    const result = await response.json();
                    if (result.share_url) {
                        const shareUrl = `https://python-cli-webapp.vercel.app${result.share_url}`;
                        showShareModal(shareUrl);
                    } else {
                        showToast("Có lỗi xảy ra khi chia sẻ mã.", "error");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    showToast("Có lỗi xảy ra khi chia sẻ mã.", "error");
                }
            });

        document
            .getElementById("copyLinkBtn")
            .addEventListener("click", function () {
                const shareUrl = document.getElementById("shareUrl").value;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast("Đã sao chép liên kết vào clipboard!", "success");
                });
            });

        document
            .getElementById("openLinkBtn")
            .addEventListener("click", function () {
                const shareUrl = document.getElementById("shareUrl").value;
                window.open(shareUrl, "_blank");
            });

        document
            .getElementById("closeModalBtn")
            .addEventListener("click", closeShareModal);
        document
            .getElementById("closeModalBtn2")
            .addEventListener("click", closeShareModal);

        window.addEventListener("click", function (event) {
            const modal = document.getElementById("shareModal");
            if (event.target === modal) {
                closeShareModal();
            }
        });

        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const closeSidebarBtn = document.getElementById("closeSidebarBtn");
        const inputRequired = document.getElementById("inputRequired");
        const inputValueContainer = document.getElementById("inputValueContainer");
        const runBtn = document.getElementById("runBtn");
        const clearBtn = document.getElementById("clearBtn");
        const saveBtn = document.getElementById("saveBtn");
        const fullscreenBtn = document.getElementById("fullscreenBtn");
        const settingsBtn = document.getElementById("settingsBtn");
        const themeToggle = document.getElementById("themeToggle");
        const advancedOptions = document.getElementById("advancedOptions");
        const resultArea = document.getElementById("resultArea");
        const resultContent = document.getElementById("resultContent");
        const toggleResult = document.getElementById("toggleResult");
        const resultTab = document.getElementById("resultTab");
        const consoleTab = document.getElementById("consoleTab");
        const aiTab = document.getElementById("aiTab");
        const consoleContent = document.getElementById("consoleContent");
        const aiContent = document.getElementById("aiContent");
        const consoleInput = document.getElementById("consoleInput");
        const consoleOutput = document.getElementById("consoleOutput");
        const aiInput = document.getElementById("aiInput");
        const aiOutput = document.getElementById("aiOutput");
        const aiSendBtn = document.getElementById("aiSendBtn");
        const aiFullscreenBtn = document.getElementById("aiFullscreenBtn");

        sidebarToggle.addEventListener("click", () => {
            sidebar.classList.toggle("-translate-x-full");
        });

        closeSidebarBtn.addEventListener("click", () => {
            sidebar.classList.add("-translate-x-full");
        });

        inputRequired.addEventListener("change", function () {
            inputValueContainer.style.display = this.checked ? "block" : "none";
            if (!this.checked) {
                document.getElementById("inputValue").value = "";
            }
        });

        settingsBtn.addEventListener("click", function () {
            advancedOptions.classList.toggle("show");
            settingsBtn
                .querySelector("i:last-child")
                .classList.toggle("fa-chevron-down");
            settingsBtn
                .querySelector("i:last-child")
                .classList.toggle("fa-chevron-right");
        });

        themeToggle.addEventListener("change", function () {
            currentTheme = this.checked ? "default" : "nord";
            editor.setOption("theme", currentTheme);
            document.body.classList.toggle("dark");
        });

        runBtn.addEventListener("click", async function () {
            const code = editor.getValue();
            const inputValue = document.getElementById("inputValue").value;

            try {
                runBtn.disabled = true;
                runBtn.innerHTML =
                    '<i class="fas fa-spinner fa-spin mr-2"></i> <span class="hidden sm:inline">Đang chạy...</span>';
                const response = await fetch("/run-python", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        code: code,
                        input_values: inputRequired.checked ? inputValue.split("\n") : []
                    })
                });

                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const result = await response.json();
                    resultArea.style.maxHeight = "50vh";
                    resultContent.style.display = "block";
                    toggleResult.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    document.getElementById("resultOutput").textContent = result.output;

                    if (result.error) {
                        document
                            .getElementById("resultOutput")
                            .classList.add("text-red-500");
                        document
                            .getElementById("resultOutput")
                            .classList.remove("text-green-400");
                    } else {
                        document
                            .getElementById("resultOutput")
                            .classList.remove("text-red-500");
                        document
                            .getElementById("resultOutput")
                            .classList.add("text-green-400");
                    }
                } else {
                    const textResult = await response.text();
                    resultArea.style.maxHeight = "50vh";
                    resultContent.style.display = "block";
                    toggleResult.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    document.getElementById("resultOutput").textContent =
                        "Lỗi server: " + textResult;
                    document
                        .getElementById("resultOutput")
                        .classList.add("text-red-500");
                    document
                        .getElementById("resultOutput")
                        .classList.remove("text-green-400");
                }

                document.getElementById("resultOutput").scrollTop =
                    document.getElementById("resultOutput").scrollHeight;
                updateCodeSuggestions();
            } catch (error) {
                console.error("Error:", error);
                resultArea.style.maxHeight = "50vh";
                resultContent.style.display = "block";
                toggleResult.innerHTML = '<i class="fas fa-chevron-down"></i>';
                document.getElementById("resultOutput").textContent =
                    "Đã xảy ra lỗi khi chạy mã Python: " + error.message;
                document.getElementById("resultOutput").classList.add("text-red-500");
                document
                    .getElementById("resultOutput")
                    .classList.remove("text-green-400");
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML =
                    '<i class="fas fa-play mr-2"></i> <span class="hidden sm:inline">Chạy</span>';
                editor.refresh();
            }
        });

        clearBtn.addEventListener("click", function () {
            editor.setValue("");
            document.getElementById("inputValue").value = "";
            resultArea.style.maxHeight = "40px";
            resultContent.style.display = "none";
            toggleResult.innerHTML = '<i class="fas fa-chevron-up"></i>';
            editor.refresh();
        });

        saveBtn.addEventListener("click", function () {
            const code = editor.getValue();
            const blob = new Blob([code], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "python_code.py";
            link.click();
        });

        fullscreenBtn.addEventListener("click", function () {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                fullscreenBtn.innerHTML =
                    '<i class="fas fa-compress-arrows-alt mr-2"></i>Thu nhỏ';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenBtn.innerHTML =
                        '<i class="fas fa-expand-arrows-alt mr-2"></i>Toàn màn hình';
                }
            }
        });

        toggleResult.addEventListener("click", function () {
            const isExpanded = resultArea.style.maxHeight === "50vh";
            if (isExpanded) {
                resultArea.style.maxHeight = "40px";
                resultContent.style.display = "none";
                consoleContent.style.display = "none";
                aiContent.style.display = "none";
                toggleResult.innerHTML = '<i class="fas fa-chevron-up"></i>';
            } else {
                resultArea.style.maxHeight = "50vh";
                if (resultTab.classList.contains("active")) {
                    resultContent.style.display = "block";
                } else if (consoleTab.classList.contains("active")) {
                    consoleContent.style.display = "block";
                } else if (aiTab.classList.contains("active")) {
                    aiContent.style.display = "block";
                }
                toggleResult.innerHTML = '<i class="fas fa-chevron-down"></i>';
            }
            editor.refresh();
        });

        resultTab.addEventListener("click", function () {
            resultTab.classList.add("active");
            consoleTab.classList.remove("active");
            aiTab.classList.remove("active");
            resultContent.style.display = "block";
            consoleContent.style.display = "none";
            aiContent.style.display = "none";
        });

        consoleTab.addEventListener("click", function () {
            consoleTab.classList.add("active");
            resultTab.classList.remove("active");
            aiTab.classList.remove("active");
            consoleContent.style.display = "block";
            resultContent.style.display = "none";
            aiContent.style.display = "none";
        });

        aiTab.addEventListener("click", function () {
            aiTab.classList.add("active");
            resultTab.classList.remove("active");
            consoleTab.classList.remove("active");
            aiContent.style.display = "block";
            resultContent.style.display = "none";
            consoleContent.style.display = "none";
        });

        consoleInput.addEventListener("keydown", async function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                const command = consoleInput.value;
                consoleInput.value = "";

                consoleHistory.push(command);
                historyIndex = consoleHistory.length;

                const inputElement = document.createElement("div");
                inputElement.className = "console-input";
                inputElement.textContent = ">>> " + command;
                consoleOutput.appendChild(inputElement);

                try {
                    const response = await fetch("/run-python", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            code: command,
                            input_values: []
                        })
                    });

                    const result = await response.json();
                    const outputElement = document.createElement("div");
                    outputElement.className = result.error
                        ? "console-error"
                        : "console-output";
                    outputElement.textContent = result.output;
                    consoleOutput.appendChild(outputElement);
                } catch (error) {
                    console.error("Error:", error);
                    const errorElement = document.createElement("div");
                    errorElement.className = "console-error";
                    errorElement.textContent = "Đã xảy ra lỗi: " + error.message;
                    consoleOutput.appendChild(errorElement);
                }

                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            } else if (event.key === "ArrowUp") {
                event.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    consoleInput.value = consoleHistory[historyIndex];
                }
            } else if (event.key === "ArrowDown") {
                event.preventDefault();
                if (historyIndex < consoleHistory.length - 1) {
                    historyIndex++;
                    consoleInput.value = consoleHistory[historyIndex];
                } else {
                    historyIndex = consoleHistory.length;
                    consoleInput.value = "";
                }
            }
        });

        aiSendBtn.addEventListener("click", sendAIMessage);
        aiInput.addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendAIMessage();
            }
        });

        async function sendAIMessage() {
            const userMessage = aiInput.value.trim();
            if (userMessage === "") return;

            aiInput.value = "";
            appendMessage("user", userMessage);

            try {
                const response = await fetch("/ai-chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ 
                        message: userMessage,
                        history: chatHistory
                    })
                });

                if (!response.ok) {
                    throw new Error("AI response error");
                }

                const result = await response.json();
                appendMessage("ai", result.response);

                // Update chat history
                chatHistory.push({ role: "user", content: userMessage });
                chatHistory.push({ role: "ai", content: result.response });

                // Limit history to last 20 messages
                if (chatHistory.length > 40) {
                    chatHistory = chatHistory.slice(-40);
                }

                // Save chat history to localStorage
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            } catch (error) {
                console.error("Error:", error);
                appendMessage("error", "Đã xảy ra lỗi khi gửi tin nhắn đến AI.");
            }

            aiOutput.scrollTop = aiOutput.scrollHeight;
        }

        function loadChatHistory() {
            const savedHistory = localStorage.getItem('chatHistory');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                chatHistory.forEach(msg => appendMessage(msg.role, msg.content));
            }
        }

        function appendMessage(type, content) {
            const messageElement = document.createElement("div");
            messageElement.className = `message ${type}-message`;
            
            const contentElement = document.createElement("div");
            contentElement.className = "message-content";
            contentElement.innerHTML = marked.parse(content);
            
            messageElement.appendChild(contentElement);
            aiOutput.appendChild(messageElement);

            // Auto-scroll to the bottom
            aiOutput.scrollTop = aiOutput.scrollHeight;
        }

        function toggleAIFullscreen() {
            const aiContent = document.getElementById('aiContent');
            isAIFullscreen = !isAIFullscreen;
            
            if (isAIFullscreen) {
                aiContent.classList.add('ai-fullscreen');
                document.body.style.overflow = 'hidden';
                aiFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                aiContent.classList.remove('ai-fullscreen');
                document.body.style.overflow = '';
                aiFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        }

        aiFullscreenBtn.addEventListener('click', toggleAIFullscreen);

        window.addEventListener('load', loadChatHistory);

        document.addEventListener("keydown", function (event) {
            if (event.ctrlKey && event.key === "Enter") {
                runBtn.click();
            }
        });

        editor.setValue(`# Tanbaycu 
# Hãy thử chạy đoạn mã mẫu này:

def fibonacci(n):
    if n <= 1:
        return n
    else:
        return fibonacci(n-1) + fibonacci(n-2)

print("Dãy số Fibonacci:")
for i in range(10):
    print(fibonacci(i), end=" ")
`);

        const resizeObserver = new ResizeObserver(() => {
            editor.refresh();
        });
        resizeObserver.observe(document.querySelector(".editor-container"));

        function addLibrary(libraryName) {
            const libraryList = document.getElementById("libraryList");
            const li = document.createElement("li");
            li.textContent = libraryName;
            li.classList.add("library-item");
            libraryList.appendChild(li);
        }

        resultArea.style.maxHeight = "40px";
        resultContent.style.display = "none";
    </script>
</body>

</html>

